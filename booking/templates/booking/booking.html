{% extends "booking/home.html" %}
{% load static %}
{% block title %} FitBlendz-Book Appointment{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking.css' %}" onerror="console.log('CSS failed to load')">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    /* Mobile-first responsive design */
    .booking-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: stretch;
        padding-top: 80px;
    }
    
    .pricing-section, .form-section {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
        box-sizing: border-box;
    }
    
    .pricing-section:hover, .form-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .pricing-title, .form-title {
        color: #333;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        text-align: center;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .pricing-sub-title, .form-sub-title {
        color: #666;
        font-size: 1rem;
        margin-bottom: 2rem;
        text-align: center;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .pricing-list {
        list-style: none;
        padding: 0;
        margin-bottom: 2rem;
    }
    
    .pricing-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 10px;
        transition: all 0.3s ease;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .pricing-list li:hover {
        background: #e3f2fd;
        transform: translateX(5px);
    }
    
    .pricing-list span:first-child {
        font-weight: 600;
        color: #333;
        flex: 1;
        min-width: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .price {
        font-weight: 700;
        font-size: 1.1rem;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .business-hours {
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-top: 1rem;
    }
    
    .business-hours h3 {
        margin-bottom: 1rem;
        font-size: 1.3rem;
        text-align: center;
    }
    
    .business-hours ul {
        list-style: none;
        padding: 0;
    }
    
    .business-hours li {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        text-align: center;
    }
    
    .business-hours li:last-child {
        border-bottom: none;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 600;
        font-size: 0.95rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 16px; /* Prevents zoom on iOS */
        transition: all 0.3s ease;
        background: #f8f9fa;
        font-family: inherit;
        box-sizing: border-box;
        max-width: 100%;
        min-width: 0;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
        max-height: 200px;
    }
    
    .btn-book {
        width: 100%;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    .btn-book:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
    }
    
    .btn-book:active {
        transform: translateY(-1px);
    }
    
    .btn-book:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-book.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .notice {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        text-align: center;
        font-weight: 500;
        border: 1px solid #c3e6cb;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .appointment-status {
        background: #e3f2fd;
        color: #1976d2;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        text-align: center;
        font-weight: 600;
        border: 1px solid #bbdefb;
        animation: pulse 2s infinite;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .map-section {
        padding: 3rem 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        margin-top: 3rem;
    }
    
    .map-title {
        text-align: center;
        color: #333;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .map-subtitle {
        text-align: center;
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 2rem;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .map-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
    }
    
    #map {
        height: 60vh;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        position: relative;
        box-sizing: border-box;
    }
    
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 1rem 2rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        font-weight: 600;
        color: #667eea;
        text-align: center;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .directions-info {
        background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
        padding: 2rem;
        border-radius: 15px;
    }
    
    .directions-info h5 {
        color: #333;
        margin-bottom: 1rem;
        font-weight: 700;
        font-size: 1.2rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .directions-info p {
        margin-bottom: 0.8rem;
        color: #555;
        line-height: 1.5;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .directions-info strong {
        color: #333;
    }
    
    .show-directions-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
        width: 100%;
        box-sizing: border-box;
    }
    
    .show-directions-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .show-directions-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .directions-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 1rem;
        border: 1px solid #e1e5e9;
        max-height: 300px;
        overflow-y: auto;
        box-sizing: border-box;
    }
    
    .directions-panel h6 {
        color: #333;
        margin-bottom: 1rem;
        font-weight: 600;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .directions-step {
        padding: 0.8rem 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .directions-step:last-child {
        border-bottom: none;
    }
    
    .step-number {
        background: #667eea;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 0.2rem;
    }
    
    .step-content {
        flex: 1;
        min-width: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .step-instruction {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.3rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .step-distance {
        font-size: 0.9rem;
        color: #666;
    }
    
    .route-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #e1e5e9;
    }
    
    .route-summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .route-summary-row:last-child {
        margin-bottom: 0;
    }
    
    .route-summary-label {
        font-weight: 600;
        color: #333;
        flex: 1;
        min-width: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .route-summary-value {
        color: #667eea;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    /* Tablet and Desktop Styles */
    @media (min-width: 768px) {
        .booking-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            padding: 2rem;
            padding-top: 80px;
        }
        
        .pricing-title, .form-title {
            font-size: 2rem;
        }
        
        .map-title {
            font-size: 2.5rem;
        }
        
        .show-directions-btn {
            width: auto;
        }
    }
    
    /* Mobile Styles */
    @media (max-width: 767px) {
        .booking-container {
            padding: 1rem;
            gap: 2rem;
        }

        .form-group label{
            color: #444;
        }

        #date{
            width: 350px;
        }

        #time{
            width: 350px;
        }
        option::placeholder{
            color: black;
        }
        .pricing-section, .form-section {
            padding: 1.5rem;
        }
        
        .pricing-title, .form-title {
            font-size: 1.5rem;
        }
        
        .map-title {
            font-size: 2rem;
        }
        
        #map {
            height: 50vh;
        }
        
        .map-container {
            padding: 1rem;
        }
        
        .directions-info {
            padding: 1.5rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 14px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .btn-book {
            padding: 12px;
            font-size: 1rem;
        }
    }
    
    @media (max-width: 480px) {
        .booking-container {
            padding: 0.5rem;
            padding-top: 80px;
        }
        
        .pricing-section, .form-section {
            padding: 1rem;
            border-radius: 15px;
        }
        
        .pricing-title, .form-title {
            font-size: 1.3rem;
        }
        
        .pricing-list li {
            padding: 0.8rem;
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 14px;
            font-size: 16px;
        }

        .form-group label{
            color: #444;
        }
        
        .btn-book {
            padding: 12px;
            font-size: 1rem;
        }
        
        .map-section {
            padding: 2rem 0.5rem;
        }
        
        .map-title {
            font-size: 1.8rem;
        }
        
        #map {
            height: 40vh;
        }
        
        .map-container {
            padding: 1rem;
        }
        
        .directions-info {
            padding: 1rem;
        }
        
        .show-directions-btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
      
    }
    @media (min-width:412px) and (max-width:430px){
      .form-group{
        width:350px;
      }
      
    }
    /* Extra small screens */
    @media (max-width: 360px) {
        .booking-container {
            padding: 0.25rem;
            padding-top: 80px;
        }
        .form-group label{
            color: #444;
        }
        .pricing-section, .form-section {
            padding: 0.75rem;
        }
        
        .pricing-title, .form-title {
            font-size: 1.2rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 12px;
            font-size: 16px;
        }
        
        .btn-book {
            padding: 10px;
            font-size: 0.9rem;
        }
    }
    
    /* Form validation styles */
    .form-group input:invalid,
    .form-group select:invalid {
        border-color: #dc3545;
    }
    
    .form-group input:valid,
    .form-group select:valid {
        border-color: #28a745;
    }
    
    /* Loading animation for form submission */
    .form-section.loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    /* Success animation */
    .success-animation {
        animation: successPulse 0.6s ease;
    }
    
    @keyframes successPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Success and error notice styles */
    .notice h3 {
        margin: 0 0 10px 0;
        color: inherit;
    }
    
    .notice p {
        margin: 5px 0;
    }
    
    /* Ensure all elements use border-box */
    *, *::before, *::after {
        box-sizing: border-box;
    }
</style>
{% endblock %}

{% block content %}
<section class="booking-container">
    <!-- LEFT: Services & Pricing -->
    <div class="pricing-section">
        <h2 class="pricing-title">‚úÇÔ∏è Our Services</h2>
      <p class="pricing-sub-title">Professional barbering services with attention to detail</p>
        <ul class="pricing-list">
            {% for service in services %}
                <li><span>{{ service.name }}</span> <span class="price">‚Çπ{{ service.price }}</span></li>
            {% endfor %}
        </ul>
        
           <div class="business-hours">
            <h3>üïí Business Hours</h3>
            <ul>
                <li>Mon - Fri: 9:00 AM - 8:00 PM</li>
                <li>Saturday: 10:00 AM - 9:00 PM</li>
                <li>Sunday: Closed</li>
            </ul>
        </div>
    </div>

    <!-- RIGHT: Appointment Form -->
    <div class="form-section">
        <h2 class="form-title">üìÖ Book Appointment</h2>
      <p class="form-sub-title">Fill in your information to book your appointment</p>
        <form method="post" id="bookingForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="name">üë§ Full Name</label>
                <input type="text" name="name" id="name" placeholder="John Doe" required minlength="2">
            </div>

            <div class="form-group">
                <label for="email">üìß Email Address</label>
                <input type="email" name="email" id="email" placeholder="john@example.com" required>
            </div>

            <div class="form-group">
                <label for="phone">üì± Phone Number</label>
                <input type="tel" name="phone" id="phone" placeholder="+91 9876543210" required pattern="[\+]?[0-9\s\-\(\)]+" minlength="10">
            </div>

            <div class="form-group">
                <label for="service">‚úÇÔ∏è Select Service</label>
                <select name="service" id="service" required>
                    <option value="">-- Select a Service --</option>
                    {% for service in services %}
                        <option value="{{ service.id }}">{{ service.name }} - ‚Çπ{{ service.price }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="date">üìÖ Select Date</label>
                <input type="date" name="date" id="date" style="color:black" required min="{{ today_date }}">
            </div>

            <div class="form-group">
                <label for="time">‚è∞ Select Time</label>
                <input type="time" name="time" id="time" style="color:black"required>
            </div>

            <div class="form-group">
                <label for="notes">üí¨ Additional Message</label>
                <textarea name="notes" id="notes" rows="4" placeholder="Any special requests or notes?"></textarea>
            </div>

            <button type="submit" class="btn-book" id="submitBtn">
                <span class="btn-text">Book Now</span>
            </button>
            
            {% if message %}
            <p class="notice">{{ message }}</p>
            {% endif %}
            
            {% if appointment_id %}
            <div id="appt-status" data-appt-id="{{ appointment_id }}" class="appointment-status"></div>
            {% endif %}
        </form>
    </div>
</section>

<!-- MAP SECTION -->
<section class="map-section">
    <h2 class="map-title">üìç Find Us</h2>
    <p class="map-subtitle">Get accurate directions to our barbershop</p>
    
    <div class="map-container">
        <div id="map">
            <div class="map-loading">üó∫Ô∏è Loading Map...</div>
        </div>
        
        <div class="directions-info">
            <h5>üìç Barbershop Location</h5>
            <p><strong>Address:</strong> Your Barbershop Address Here</p>
            <p><strong>Phone:</strong> +91 6239514954</p>
            
            <button id="show-directions-btn" class="show-directions-btn">üó∫Ô∏è Get Directions</button>
            
            <div id="directions-panel" class="directions-panel" style="display: none;">
                <h6>üöó Turn-by-Turn Directions</h6>
                <div id="directions-content"></div>
            </div>
        </div>
    </div>
</section>

<script>
// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bookingForm');
    const submitBtn = document.getElementById('submitBtn');
    const today = new Date().toISOString().split('T')[0];
    
    // Check if required elements exist
    if (!form || !submitBtn) {
        console.error('Required form elements not found');
        return;
    }
    
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.min = today;
    }
    
    // Function to update time constraints based on selected date
    function updateTimeConstraints() {
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const selectedDate = dateInput.value;
        
        if (selectedDate && window.workingHours) {
            // Get day of week (0=Monday, 1=Tuesday, etc. in Django, but 0=Sunday in JavaScript)
            const date = new Date(selectedDate);
            const dayOfWeek = date.getDay();
            
            // Convert JavaScript day (0=Sunday) to Django day (0=Monday)
            const djangoDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            // Reset time input
            timeInput.value = '';
            
            // Get working hours for this day
            const dayHours = window.workingHours[djangoDay];
            
            if (!dayHours || !dayHours.is_open) {
                // Closed on this day
                timeInput.disabled = true;
                timeInput.placeholder = `Closed on ${dayHours ? dayHours.day_name : 'this day'}`;
                timeInput.min = '';
                timeInput.max = '';
            } else {
                // Open on this day
                timeInput.disabled = false;
                timeInput.placeholder = `Select time between ${dayHours.open_time} and ${dayHours.close_time}`;
                timeInput.min = dayHours.open_time;
                timeInput.max = dayHours.close_time;
            }
        }
    }
    
    // Function to fetch working hours from API
    async function fetchWorkingHours() {
        try {
            const response = await fetch('/api/working-hours/');
            const data = await response.json();
            
            if (data.success) {
                window.workingHours = data.working_hours;
                // Update time constraints if a date is already selected
                updateTimeConstraints();
            } else {
                console.error('Failed to fetch working hours:', data.error);
            }
        } catch (error) {
                console.error('Error fetching working hours:', error);
        }
    }
    
    // Add event listener for date changes
    const dateElement = document.getElementById('date');
    if (dateElement) {
        dateElement.addEventListener('change', updateTimeConstraints);
    }
    
    // Fetch working hours and initialize time constraints
    fetchWorkingHours();
    
    // Form submission with loading state
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
        submitBtn.querySelector('.btn-text').textContent = 'Booking...';
        
        // Collect form data
        const formData = new FormData(form);
        const data = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Get CSRF token
        let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        console.log('CSRF token element:', csrfToken);
        
        if (!csrfToken) {
            // Try to get CSRF token from cookies as fallback
            const cookies = document.cookie.split(';');
            console.log('All cookies:', document.cookie);
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken = { value: value };
                    console.log('Found CSRF token in cookies:', value);
                    break;
                }
            }
        } else {
            console.log('Found CSRF token in form:', csrfToken.value);
        }
        
        if (!csrfToken) {
            console.error('CSRF token not found');
            alert('Security error: CSRF token not found. Please refresh the page and try again.');
            return;
        }
        
        // Submit form via AJAX
        fetch('/book/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken.value
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Security error: CSRF token invalid. Please refresh the page and try again.');
                } else if (response.status === 400) {
                    throw new Error('Invalid data: Please check your form inputs and try again.');
                } else {
                    throw new Error(`Server error: ${response.status}. Please try again later.`);
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'notice success-animation';
                successDiv.innerHTML = `
                    <h3>‚è≥ Appointment Request Submitted!</h3>
                    <p>${data.message}</p>
                    <p><strong>Appointment ID:</strong> ${data.appointment_id}</p>
                    <p><em>Status: Pending Barber Approval</em></p>
                `;
                form.parentNode.insertBefore(successDiv, form.nextSibling);
                
                // Reset form
                form.reset();
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            } else {
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'notice';
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.style.border = '1px solid #f5c6cb';
                errorDiv.innerHTML = `<p><strong>Error:</strong> ${data.error}</p>`;
                form.parentNode.insertBefore(errorDiv, form.nextSibling);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'notice';
            errorDiv.style.background = '#f8d7da';
            errorDiv.style.color = '#721c24';
            errorDiv.style.border = '1px solid #f5c6cb';
            errorDiv.innerHTML = '<p><strong>Error:</strong> An unexpected error occurred. Please try again.</p>';
            form.parentNode.insertBefore(errorDiv, form.nextSibling);
            
            // Remove error message after 5 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        })
        .finally(() => {
            // Reset button state
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            submitBtn.querySelector('.btn-text').textContent = 'Book Now';
        });
    });
    
    // Real-time validation
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#28a745';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });
        
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.style.borderColor = '#28a745';
            }
        });
    });
    
    // Phone number formatting
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.length <= 2) {
                value = '+' + value;
            } else if (value.length <= 7) {
                value = '+' + value.slice(0, 2) + ' ' + value.slice(2);
            } else {
                value = '+' + value.slice(0, 2) + ' ' + value.slice(2, 7) + ' ' + value.slice(7);
            }
        }
        e.target.value = value;
        });
    }
});

// Appointment status polling
(function(){
  const container = document.getElementById('appt-status');
  if (!container) return;
  
  const apptId = container.dataset.apptId;
  if (!apptId) return;
    
  const updateStatusDisplay = (status, message) => {
    container.textContent = message;
    container.className = `appointment-status ${status}`;
  };
    
  const poll = async () => {
    try {
      const res = await fetch(`/status/${apptId}/`, { 
        headers: { 'Accept': 'application/json' } 
      });
      
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      
      const data = await res.json();
            
      if (data.status === 'booked') {
        updateStatusDisplay('confirmed', '‚úÖ Your appointment is confirmed!');
        clearInterval(timer);
      } else if (data.status === 'denied') {
        updateStatusDisplay('denied', '‚ùå Your appointment was not confirmed');
        clearInterval(timer);
      } else if (data.status === 'pending') {
        updateStatusDisplay('pending', '‚è≥ Waiting for barber to confirm...');
      } else {
        updateStatusDisplay('pending', '‚è≥ Processing your appointment...');
      }
    } catch (e) {
      console.error('Status check failed:', e);
      container.textContent = '‚ö†Ô∏è Unable to check appointment status';
      container.style.background = '#fff3cd';
      container.style.color = '#856404';
    }
  };
    
  const timer = setInterval(poll, 5000);
  poll(); // Initial check
})();

// Advanced OpenStreetMap with Mapbox Integration
let map, routingControl, userMarker, barbershopMarker;
let isDirectionsVisible = false;
let currentRoute = null;

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Add event listener for directions button
    const directionsBtn = document.getElementById('show-directions-btn');
    if (directionsBtn) {
        directionsBtn.addEventListener('click', getDirections);
    }
});

function initMap() {
    // CHANGE THIS TO YOUR ACTUAL BARBERSHOP ADDRESS
    const barbershopAddress = "Your Actual Barbershop Address Here"; // PUT YOUR REAL ADDRESS HERE
    
    console.log('Looking up address:', barbershopAddress);
    
    // Geocode the address to get coordinates
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(barbershopAddress)}&limit=1`)
        .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                const coordinates = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                console.log('Found coordinates:', coordinates);
                initializeMapWithCoordinates(coordinates);
                } else {
                console.error('Address not found, using fallback coordinates');
                // Fallback coordinates (you can update these)
                initializeMapWithCoordinates([40.7128, -74.0060]); // Example: New York
            }
        })
        .catch(error => {
            console.error('Geocoding failed:', error);
            // Fallback coordinates
            initializeMapWithCoordinates([40.7128, -74.0060]); // Example: New York
        });
}

function initializeMapWithCoordinates(barbershopLocation) {
    console.log('Initializing map with coordinates:', barbershopLocation);
    
    // Initialize the map with high-quality tiles
    map = L.map('map', {
        center: barbershopLocation,
        zoom: 15,
        zoomControl: true,
        attributionControl: true
    });
    
    console.log('Map initialized:', map);
    
    // Use OpenStreetMap tiles (completely free and reliable)
    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '¬© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add error handling for tile loading
    tileLayer.on('tileerror', function(e) {
        console.error('Tile loading error:', e);
        // Fallback to a different tile provider if needed
        L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);
    });
    
    console.log('Tile layer added:', tileLayer);
    
    // Add barbershop marker with custom icon
    const barbershopIcon = L.divIcon({
        html: '<div style="background: #dc3545; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">‚úÇÔ∏è</div>',
        className: 'custom-div-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });
    
    barbershopMarker = L.marker(barbershopLocation, { icon: barbershopIcon })
        .addTo(map)
        .bindPopup(`
            <div style="text-align: center; padding: 10px; min-width: 200px;">
                <h3 style="margin: 0 0 10px 0; color: #667eea;">‚úÇÔ∏è FitBlendz Barbershop</h3>
                <p style="margin: 0; color: #666;">Your destination</p>
                <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">Click "Get Directions" to find your way here</p>
            </div>
        `, {
            maxWidth: 250,
            className: 'custom-popup'
        });
    
    // Remove loading message
    const loadingElement = document.querySelector('.map-loading');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    // Force map to refresh and show tiles
    setTimeout(() => {
        map.invalidateSize();
        console.log('Map size invalidated');
    }, 100);
}

function getDirections() {
    const directionsBtn = document.getElementById('show-directions-btn');
    const directionsPanel = document.getElementById('directions-panel');
    
    if (isDirectionsVisible) {
        // Hide directions
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        if (userMarker) {
            map.removeLayer(userMarker);
            userMarker = null;
        }
        directionsPanel.style.display = 'none';
        directionsBtn.textContent = 'üó∫Ô∏è Get Directions';
        isDirectionsVisible = false;
        return;
    }
    
    // Show loading state
    directionsBtn.disabled = true;
    directionsBtn.textContent = 'üìç Getting your location...';
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLocation = [position.coords.latitude, position.coords.longitude];
                
                // Add user marker with custom icon
                const userIcon = L.divIcon({
                    html: '<div style="background: #007bff; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üìç</div>',
                    className: 'custom-div-icon',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                userMarker = L.marker(userLocation, { icon: userIcon })
                    .addTo(map)
                    .bindPopup('üìç Your Location', {
                        className: 'custom-popup'
                    });
                
                // Calculate route using OpenStreetMap routing
                calculateRoute(userLocation, barbershopMarker.getLatLng());
                
                // Reset button
                directionsBtn.disabled = false;
            },
            (error) => {
                alert('Unable to get your location. Please enable GPS permissions and try again.');
                directionsBtn.disabled = false;
                directionsBtn.textContent = 'üó∫Ô∏è Get Directions';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        alert('Geolocation is not supported by this browser.');
        directionsBtn.disabled = false;
        directionsBtn.textContent = 'üó∫Ô∏è Get Directions';
    }
}

function calculateRoute(origin, destination) {
    const directionsBtn = document.getElementById('show-directions-btn');
    directionsBtn.textContent = 'üîÑ Calculating route...';
    
    // Use OpenStreetMap Routing Machine for accurate routing
    if (routingControl) {
        map.removeControl(routingControl);
    }
    
        routingControl = L.Routing.control({
            waypoints: [
            L.latLng(origin[0], origin[1]),
            L.latLng(destination.lat, destination.lng)
            ],
            routeWhileDragging: false,
            draggableWaypoints: false,
            addWaypoints: false,
            show: false,
        createMarker: function() { return null; }, // Don't create default markers
        lineOptions: {
            styles: [
                { color: '#667eea', opacity: 0.8, weight: 6 }
            ]
        }
    }).addTo(map);
    
    // Listen for route calculation
    routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        if (routes && routes.length > 0) {
            const route = routes[0];
            currentRoute = route;
            
            // Display directions
            displayDirections(route);
            
            // Fit map to show entire route
            const bounds = L.latLngBounds(origin, destination);
            map.fitBounds(bounds, { padding: [20, 20] });
            
            // Show directions panel
            document.getElementById('directions-panel').style.display = 'block';
            directionsBtn.textContent = 'üó∫Ô∏è Hide Directions';
            isDirectionsVisible = true;
                } else {
            alert('Unable to calculate route. Please try again.');
        }
        
        directionsBtn.disabled = false;
    });
    
    routingControl.on('routingerror', function(e) {
        alert('Routing error: ' + e.error.message);
        directionsBtn.disabled = false;
        directionsBtn.textContent = 'üó∫Ô∏è Get Directions';
    });
}

function displayDirections(route) {
    const directionsContent = document.getElementById('directions-content');
    
    let html = '';
    
    // Route summary
    const summary = route.summary;
    html += `
        <div class="route-summary">
            <div class="route-summary-row">
                <span class="route-summary-label">üöó Total Distance:</span>
                <span class="route-summary-value">${(summary.totalDistance / 1000).toFixed(1)} km</span>
            </div>
            <div class="route-summary-row">
                <span class="route-summary-label">‚è±Ô∏è Estimated Time:</span>
                <span class="route-summary-value">${Math.round(summary.totalTime / 60)} minutes</span>
            </div>
        </div>
    `;
    
    // Step-by-step directions
    route.instructions.forEach((instruction, index) => {
        html += `
            <div class="directions-step">
                <div class="step-number">${index + 1}</div>
                <div class="step-content">
                    <div class="step-instruction">${instruction.text}</div>
                    <div class="step-distance">${(instruction.distance / 1000).toFixed(1)} km</div>
                </div>
            </div>
        `;
    });
    
    directionsContent.innerHTML = html;
}

// Add custom CSS for map elements
const style = document.createElement('style');
style.textContent = `
    .custom-popup .leaflet-popup-content-wrapper {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .custom-popup .leaflet-popup-tip {
        background: white;
    }
    
    .leaflet-routing-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border: none;
        padding: 10px;
        max-width: 300px;
    }
    
    .leaflet-routing-container h2 {
        font-size: 1rem;
        margin: 0 0 10px 0;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 5px;
    }
    
    .leaflet-routing-alt {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .leaflet-routing-alt h3 {
        font-size: 0.9rem;
        margin: 5px 0;
        color: #667eea;
    }
    
    .leaflet-routing-alt tr {
        font-size: 0.8rem;
    }
`;
document.head.appendChild(style);
const selectElement = document.getElementById('service');

if (selectElement) {
    selectElement.addEventListener('change', function () {
        if (this.value === "") {
            this.style.color = "#888"; // Placeholder color
        } else {
            this.style.color = "#000"; // Regular color
        }
    });

    // Set initial color
    window.addEventListener('load', () => {
        if (selectElement.value === "") {
            selectElement.style.color = "#888";
        }
    });
}

{% comment %} const selectElement = document.getElementById('date');

selectElement.addEventListener('change', function () {
  if (this.value === "") {
    this.style.color = "#888"; // Placeholder color
  } else {
    this.style.color = "#000"; // Regular color
  }
});

// Set initial color
window.addEventListener('load', () => {
  if (selectElement.value === "") {
    selectElement.style.color = "#888";
  }
});
</script>

<!-- Map JavaScript Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

{% endblock %}